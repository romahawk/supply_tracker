{% extends "base_clean.html" %}
{% block title %}Stock IN Report{% endblock %}
{% block body %}

<!-- Print Button -->
<div class="flex justify-end px-[50px] mt-6 no-print">
  <button onclick="window.print()" class="bg-gray-700 hover:bg-gray-900 text-white px-4 py-2 rounded shadow text-sm">
    üñ®Ô∏è Print
  </button>
</div>

<!-- Report Block -->
<div class="print-area" id="pdf-report"
  class="bg-white dark:bg-gray-800 p-6 rounded shadow max-w-full px-[50px] mt-10 relative">
  <div class="flex justify-between items-start mb-6">
    <div>
      <h2 class="text-2xl font-bold mb-2">Stock IN Report</h2>
      <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
        <div>
          <span class="font-semibold">Warehouse:</span>
          <span class="ml-2">{{ item.warehouse_address }}</span>
        </div>
        <div>
          <span class="font-semibold">Pos. No.:</span>
          <span class="ml-2">{{ item.pos_no }}</span>
        </div>
        <div>
          <span class="font-semibold">Client:</span>
          <span class="ml-2">{{ item.client }}</span>
        </div>
        <div>
          <span class="font-semibold">Client Ref.:</span>
          <span class="ml-2">{{ item.customer_ref }}</span>
        </div>
      </div>

    </div>
    <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="Logo" class="w-36 object-contain h-auto">
  </div>

  <div class="overflow-auto">
    <table class="w-full text-sm text-left border">
      <thead class="bg-gray-100 dark:bg-gray-700 text-xs text-gray-700 dark:text-gray-300">
        <tr>
          <th class="p-2 border w-[120px]">Entrance</th>
          <th class="p-2 border">Article/Batch</th>
          <th class="p-2 border">Colli</th>
          <th class="p-2 border">Packing</th>
          <th class="p-2 border">PCS</th>
          <th class="p-2 border">Colli/Pal.</th>
          <th class="p-2 border">Pcs Total</th>
          <th class="p-2 border">Pal.</th>
          <th class="p-2 border w-[200px]">Product</th>
          <th class="p-2 border">Gross kg</th>
          <th class="p-2 border">Net kg</th>
          <th class="p-2 border w-[200px]">Sender</th>
          <th class="p-2 border">Customs</th>
          <th class="p-2 border">Stockref</th>
          <th class="p-2 border text-center no-print">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in entries %}
        <tr class="border-t">
          <td class="p-2 border">{{ entry.entrance_date }}</td>
          <td class="p-2 border">{{ entry.article_batch }}</td>
          <td class="p-2 border">{{ entry.colli }}</td>
          <td class="p-2 border">{{ entry.packing }}</td>
          <td class="p-2 border">{{ entry.pcs }}</td>
          <td class="p-2 border">{{ entry.colli_per_pal }}</td>
          <td class="p-2 border">{{ entry.pcs_total }}</td>
          <td class="p-2 border">{{ entry.pal }}</td>
          <td class="p-2 border truncate" title="{{ entry.product }}">{{ entry.product }}</td>
          <td class="p-2 border">{{ entry.gross_kg }}</td>
          <td class="p-2 border">{{ entry.net_kg }}</td>
          <td class="p-2 border truncate" title="{{ entry.sender }}">{{ entry.sender }}</td>
          <td class="p-2 border">{{ entry.customs_status }}</td>
          <td class="p-2 border">{{ entry.stockref }}</td>
          <td class="p-2 border text-center no-print">
            <a href="{{ url_for('warehouse.edit_stockreport', entry_id=entry.id) }}"
              class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs">Edit</a>
            <form method="POST" action="{{ url_for('warehouse.delete_stockreport', entry_id=entry.id) }}"
              class="inline">
              <button type="submit" onclick="return confirm('Delete this entry?')"
                class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs ml-1">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
        <tr class="text-sm font-semibold bg-gray-50">
          <td colspan="2" class="px-2 py-1 border text-right">TOTAL:</td>
          <td class="px-2 py-1 border">{{ entries | sum(attribute='colli') }}</td>
          <td class="px-2 py-1 border"></td>
          <td class="px-2 py-1 border">{{ entries | sum(attribute='pcs') }}</td>
          <td class="px-2 py-1 border"></td>
          <td class="px-2 py-1 border">{{ entries | sum(attribute='pcs_total') }}</td>
          <td class="px-2 py-1 border">{{ entries | sum(attribute='pal') }}</td>
          <td class="px-2 py-1 border"></td>
          <td class="px-2 py-1 border">{{ entries | sum(attribute='gross_kg') }}</td>
          <td class="px-2 py-1 border">{{ entries | sum(attribute='net_kg') }}</td>
          <td colspan="4" class="px-2 py-1 border"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Customs & Signature Info -->
  <div class="grid grid-cols-3 gap-4 mt-8 text-sm">
    <div>
      <label class="block font-medium">ATB First:</label>
      <span class="block mt-1 text-gray-700 dark:text-gray-300">{{ atb_frist or '‚Äî' }}</span>
    </div>
    <div>
      <label class="block font-medium">Customs OZL:</label>
      <span class="block mt-1 text-gray-700 dark:text-gray-300">{{ customs_ozl or '‚Äî' }}</span>
    </div>
    <div>
      <label class="block font-medium">Free till:</label>
      <span class="block mt-1 text-gray-700 dark:text-gray-300">{{ free_till or '‚Äî' }}</span>
    </div>
  </div>

  <!-- Signature -->
  <div class="grid grid-cols-2 gap-8 mt-10">
    <div class="text-center">
      <p class="text-sm text-gray-700 mb-1">Date: {{ signature_date_client or '‚Äî' }}</p>
      <img src="{{ url_for('static', filename='images/signatures/' + (signature_client or 'signature1.png')) }}"
        alt="Client Signature" class="mx-auto w-32 h-auto mb-2">
      <div class="border-t border-black w-2/3 mx-auto"></div>
      <p class="text-sm mt-1">Date & Signature</p>
    </div>
    <div class="text-center">
      <p class="text-sm text-gray-700 mb-1">Date: {{ signature_date_warehouse or '‚Äî' }}</p>
      <img src="{{ url_for('static', filename='images/signatures/' + (signature_warehouse or 'signature1.png')) }}"
        alt="Warehouse Signature" class="mx-auto w-32 h-auto mb-2">
      <div class="border-t border-black w-2/3 mx-auto"></div>
      <p class="text-sm mt-1">Signature Warehouse</p>
    </div>
  </div>
</div>

<!-- Auto PDF Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    function imagesLoaded(container) {
      return new Promise((resolve) => {
        const images = container.querySelectorAll("img");
        let loadedCount = 0;
        if (images.length === 0) return resolve();
        images.forEach((img) => {
          if (img.complete) {
            loadedCount++;
            if (loadedCount === images.length) resolve();
          } else {
            img.onload = () => {
              loadedCount++;
              if (loadedCount === images.length) resolve();
            };
            img.onerror = () => {
              loadedCount++;
              if (loadedCount === images.length) resolve();
            };
          }
        });
      });
    }

    const element = document.getElementById("pdf-report");
    if (element) {
      imagesLoaded(element).then(() => {
        html2pdf()
          .set({
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
            margin: 10,
            filename: "StockReport.pdf",
          })
          .from(element)
          .save();
      });
    }
  });
</script>
{% endblock %}